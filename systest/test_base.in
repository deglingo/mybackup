#!@SHELL@
# -*- shell-script -*-


DAY0='1979/12/31 00:00:00'

_setup_day_1()
{
	local date="$1" size="${TEST_MIRROR_FSIZE:-1}"
	st_mkfile -r . -d "$date" -s "$size" "/DISK_1/FILE_1A" -R
	st_mkfile -r . -d "$date" -s "$size" "/DISK_1/FILE_1B" -R
	st_mkfile -r . -d "$date" -s "$size" "/DISK_1/FILE_1C" -R
	st_mkfile -r . -d "$date" -s "$size" "/DISK_2/FILE_2A" -R
	# ? touch -d "$date" "$dir/DISK_1" "$dir/DISK_2"
}

_setup_day_2()
{
	local date="$1" size="${TEST_MIRROR_FSIZE:-1}"
	# don't touch 1A, modify 1B, delete 1C and create 1D
	st_mkfile -f -r . -d "$date" "/DISK_1/FILE_1B" -R
	rm DISK_1/FILE_1C
	st_mkfile -r . -d "$date" "/DISK_1/FILE_1D" -R
}

_setup_day_3()
{
	local date="$1" size="${TEST_MIRROR_FSIZE:-1}"
	# [todo]
}


# setup
#
test_base_setup()
{
	# setup_fs
	test "$ST_RUNDIR/fs.stamp-h" -nt "$ST_ARG0" || {
		rm -rf "$ST_RUNDIR/fs";
		mkdir "$ST_RUNDIR/fs";
		st_setup_fs "$DAY0" "$ST_RUNDIR/fs" 3 _setup_day_;
		date >"$ST_RUNDIR/fs.stamp-h"; }

	st_mkfile "/etc/mybackup/TEST/mybackup.conf" - <<EOF
{
  "mailto": "${MYBACKUP_SYSTEST_MAILTO:-}",
  "scripts": {
    "HOOK": {
      "prog": "./HOOK",
      "options": ["%(config)s", "%(disk)s", "%(orig)s", "%(path)s"]
    }
  },
  "disks": {
    "DISK_1": {
      "orig": "$ST_ROOTDIR/orig/DISK_1",
      "path": "$ST_ROOTDIR/fs/DISK_1",
      "hooks": [{
        "script": "HOOK",
        "triggers": "schedule",
        "options": ["extra", "args..."]
      }]
    },
    "DISK_2": {
      "orig": "",
      "path": "$ST_ROOTDIR/fs/DISK_2",
      "hooks": []
    }
  }
}
EOF

	st_mkfile -m755 "/etc/mybackup/TEST/HOOK" - <<EOF
#!/bin/sh
echo "HOOK: \$# ARGS:"
for A in \$@; do
  echo " - '\$A'"
done
echo "HOOK: ALL DONE!"
EOF
}


# main
#
test_base_main()
{
	trace "MBDUMP: `which mbdump`"
	st_mbdump --help >"$ST_ROOTDIR/tmp/mbdump-help.txt"
	
	# go
	for day in `seq 1 3`; do
		date=`st_fakedate -d$day -h1`
		title "DAY $day" 70
		st_sync "$ST_RUNDIR/fs/day$day" "$ST_ROOTDIR/fs"
		_MB_SYSTEST_DATE="$date" st_mbdump TEST
		# just one time, make sure this does nothing
		test $day -ne 1 || {
			date=`st_fakedate -d$day -h2`;
			_MB_SYSTEST_DATE="$date" st_mbdump TEST; }
		# also try the -f options
		test $day -ne 1 || {
			date=`st_fakedate -d$day -h2`;
			_MB_SYSTEST_DATE="$date" st_mbdump -f TEST; }
	done
}
